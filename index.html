<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="robots" content="noindex,nofollow" />
    <title></title>
    <script src="https://telegram.org/js/telegram-web-app.js?1"></script>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }
        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
    </script>
    <link rel="stylesheet" href="build/output.css"/>
    <style>
        body {
            font-family: sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            font-size: 16px;
            margin: 0;
            padding: 0;
            color-scheme: var(--tg-color-scheme);
        }

        a {
            color: var(--tg-theme-link-color, #2678b6);
        }

        button, button[type="submit"] {
            display: block;
            width: 100%;
            font-size: 14px;
            padding: 12px 20px;
            border-radius: 4px;
            background-color: var(--tg-theme-button-color, #50a8eb);
            color: var(--tg-theme-button-text-color, #ffffff);
            cursor: pointer;
        }
    </style>
</head>

<body>

<section class="p-4">
        <label class="block mt-3 dark:text-blue-600">
            Chats
            <div id="expenses_chats" class="w-full hs-dropdown relative inline-flex" data-hs-dropdown-auto-close="inside">
                <button id="hs-dropdown-item-checkbox" type="button" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border border-gray-200 font-medium bg-white text-gray-700 shadow-sm align-middle hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-blue-600 dark:bg-gray-800 dark:hover:bg-slate-800 dark:border-gray-700 dark:text-gray-400 dark:hover:text-white dark:focus:ring-offset-gray-800 transition-all text-sm">
                    Select chat
                    <svg class="hs-dropdown-open:rotate-180 w-2.5 h-2.5 text-gray-600" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 5L8.16086 10.6869C8.35239 10.8637 8.64761 10.8637 8.83914 10.6869L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            
                <div id="expenses_chats_dropdown" class="z-20 hs-dropdown-menu transition-[opacity,margin] duration hs-dropdown-open:opacity-100 opacity-0 hidden min-w-[15rem] bg-white shadow-md rounded-lg p-2 mt-2 dark:bg-gray-800 dark:border dark:border-gray-700">
                </div>
            </div>
        </label>


        <label class="block mt-3 dark:text-red-400">
            Description
            <textarea id="expenses_description" cols="30" rows="3" class="border py-3 px-4 block w-full border-gray-200 rounded-md text-sm focus:border-blue-500 focus:ring-blue-500" rows="3" placeholder="Enter description"></textarea>
        </label>
        <label class="block mt-3 dark:text-red-400">
            Amount
            <input id="expenses_amount" type="number" class="border py-3 px-4 block w-full border-gray-200 rounded-md text-sm focus:border-blue-500 focus:ring-blue-500">
        </label>
        <label class="block mt-3 dark:text-red-400">
            Currencies
            <div id="expenses_currencies" class="w-full hs-dropdown relative inline-flex" data-hs-dropdown-auto-close="inside">
                <button id="hs-dropdown-item-checkbox" type="button" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border border-gray-200 font-medium bg-white text-gray-700 shadow-sm align-middle hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-blue-600 dark:bg-gray-800 dark:hover:bg-slate-800 dark:border-gray-700 dark:text-gray-400 dark:hover:text-white dark:focus:ring-offset-gray-800 transition-all text-sm">
                    Select currency
                    <svg class="hs-dropdown-open:rotate-180 w-2.5 h-2.5 text-gray-600" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 5L8.16086 10.6869C8.35239 10.8637 8.64761 10.8637 8.83914 10.6869L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            
                <div id="expenses_currencies_dropdown" class="hs-dropdown-menu transition-[opacity,margin] duration hs-dropdown-open:opacity-100 opacity-0 hidden min-w-[15rem] bg-white shadow-md rounded-lg p-2 mt-2 dark:bg-gray-800 dark:border dark:border-gray-700" aria-labelledby="hs-dropdown-item-checkbox">
                </div>
            </div>
        </label>

        <div id="error-message" class="text-red-500 my-4 bg-red-200 rounded"></div>
        <button onclick="sendData()" class="mt-4">Send data</button>
</section>

<script type="application/javascript">
    const SERVER_ENDPOINT = 'https://3.83.67.15.sslip.io';

    Telegram?.WebApp?.ready();

    const initData = Telegram?.WebApp?.initData || "";
    const initDataUnsafe = Telegram?.WebApp?.initDataUnsafe || {};
    const themeParams = Telegram?.WebApp?.themeParams || {};
    const userId = initDataUnsafe?.user?.id;

    document.querySelector('#themeData')?.html(JSON.stringify(themeParams, null, 2));

    Telegram?.WebApp.MainButton
        .setText('Send data')
        .show()
        .onClick(function(){ sendData(); });

    Telegram?.WebApp.onEvent('themeChanged', function() {
        if (document.querySelector('#themeData')?.innerHTML) {
            document.querySelector('#themeData').innerHTML = JSON.stringify(themeParams, null, 2);
        }
    });

    function getCheckedFromDropdown(inputsName) {
        let id;

        const inputs= document.getElementsByName(inputsName);
            
        for (i = 0; i < inputs.length; i++) {
            if (inputs[i].checked) {
                id = inputs[i].id;
            }
        }

        return id;
    }

    async function sendData() {
        const expensesDescription = document.getElementById('expenses_description')?.value;
        const expensesAmount = document.getElementById('expenses_amount')?.value;

        const expensesCurrencyId = getCheckedFromDropdown('currency');
        const expensesChatId = getCheckedFromDropdown('chat');

        if (!expensesCurrencyId || !expensesChatId) {
            const errorMessageEl = document.getElementById('error-message');
            errorMessageEl.innerHTML = '<div class="p-4">Please, fill all fields above.</div>'
            return;
        }

        const body = {
            _auth: initData,

            description: expensesDescription,
            amount: expensesAmount,
            currency: expensesCurrencyId.slice(-(expensesCurrencyId.length - "radio_currency_".length)),
            chat: expensesChatId.slice(-(expensesChatId.length - "radio_chat_".length)),
        };

        const res = await fetch(SERVER_ENDPOINT + '/api/createTransaction', {
            method: 'POST',
            body: JSON.stringify(body),
            headers: {
                'Content-Type': 'application/json'
            },
        });

        const data = await res.json();
        console.log('data', data);
    }

    async function getCurrencies() {
        const res = await fetch(SERVER_ENDPOINT + '/api/currencies/', {})
        const currencies = await res.json();

        document.getElementById('expenses_currencies_dropdown').innerHTML = currencies.reduce((acc, currency) => acc + `
            <div class="relative flex items-start rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                <label for="radio_currency_${currency.id}" class="flex items-center w-full py-3 px-3 gap-3">
                    <input value="${currency.id}" id="radio_currency_${currency.id}" name="currency" type="radio" class="border-gray-200 rounded-full text-blue-600 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700 dark:checked:bg-blue-500 dark:checked:border-blue-500 dark:focus:ring-offset-gray-800">
                    <span class="block text-sm font-semibold text-gray-800 dark:text-gray-300">${currency.symbol} ${currency.name}</span>
                </label>
            </div>
        ` ,``)

        await getCurrentCurrency()
    }

    getCurrencies();

    async function getCurrentCurrency() {
        const res = await fetch(SERVER_ENDPOINT + '/api/currencies/?user_id=' + userId, {})
        const currency = await res.json();

        document.getElementById('radio_currency_' + currency.id).checked = true;
    }

    async function getChats() {
        const res = await fetch(SERVER_ENDPOINT + '/api/chats/?user_id=' + userId, {})
        const chats = await res.json();

        document.getElementById('expenses_chats_dropdown').innerHTML = chats.reduce((acc, chat) => acc + `
            <div class="relative flex items-start rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                <label for="radio_chat_${chat.id}" class="flex items-center w-full py-3 px-3 gap-3">
                    <input value="${chat.id}" id="radio_chat_${chat.id}" name="chat" type="radio" class="border-gray-200 rounded-full text-blue-600 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700 dark:checked:bg-blue-500 dark:checked:border-blue-500 dark:focus:ring-offset-gray-800">
                    <span class="block text-sm font-semibold text-gray-800 dark:text-gray-300">${chat.title}</span>
                </label>
            </div>
        ` ,``)
    }

    getChats();
</script>
<script src="./build/preline/dist/preline.js"></script>
</body>
</html>
